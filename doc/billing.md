# 📄 **[2-1] 청구서 발송 관리 – 통합 기능명세서**

* * *

## ✅ A. 기능 개요

| 기능 구분 | 설명 |
| --- | --- |
| 목록 조회 | 청구서 발송 이력 검색 및 상태 확인 |
| 계약 정보 갱신 | SAP RFC 호출로 실시간 계약 정보 반영 |
| 발송 처리 | 개별/일괄 청구서 이메일 발송 |
| 청구서 상세 | 선택 항목에 대한 세부 정보 편집 및 발송 정보 수정 |
| 파일 출력 | HTML/Excel 파일 자동 생성 및 미리보기 |

* * *

## ✅ B. 프론트엔드 기능명세서

### 1. 📃 목록 화면

#### ✅ 경로

* `/billing`

#### ✅ 필터 및 검색 기능

| 항목 | 설명 |
| --- | --- |
| 기간 검색 | 연/월/일 단위 캘린더, 전월/다음달 이동 버튼 포함 (다음달 제한) |
| 기본 월 설정 | 1일이면 전월, 2일 이후는 당월 |
| 셀렉박스 | 사업자명(기본), 사업자번호, 대표자, 이메일 기준 검색 |
| 발송 결과 필터 | 전체(기본), 미발송, 발송 성공, 발송 실패 |
| 검색 버튼 | 조건 기반 결과 테이블 렌더링 |

#### ✅ 목록 테이블 필드

| 항목 | 설명 |
| --- | --- |
| No | 내림차순 정렬 기준 |
| 사업자명 | 클릭 시 수정 페이지로 이동 |
| 사업자번호 / 대표자 / 이메일 | 기본 정보 |
| 청구월 | 연/월 단위 |
| 첨부파일 | HTML, Excel, 기타 업로드 파일 다운로드 버튼 |
| 수정자/수정일 | 마지막 수정 정보 |
| 발송 여부 | 상태: 미발송, 성공, 실패 |
| 발송일 | 재발송 포함 최근 발송일 |
| 발송 이력 | 별도 테이블에서 발송일, 상태 저장 (비동기 로딩 가능) |

* * *

### 2. ✏️ 등록/수정 페이지

#### ✅ 경로

* `/billing/[id]/edit`

#### ✅ 구성 섹션 및 항목

| 섹션 | 항목 요약 |
| --- | --- |
| 공급받는자 | 사업자 정보 표시(수정 불가) + 수신 이메일 |
| 공급자 | 고정 정보 표시 + 인감 노출 여부 + 고객센터 안내 정보 수정 가능 |
| 이용정보 | 청구월, 납부기한 (SAP RFC 데이터 기반), 결제정보 마스킹 표시 |
| 결제안내 | 텍스트 필드 (300자 제한, 기본 문구 자동 입력) |
| 선납금 정보 | 금액, 잔여금, 기간(캘린더) |
| 청구대금 상세 | 주문번호 ~ 연락처 등 20여 항목, 일부 캘린더 필드 포함 |
| 추가 파일 | 체크박스 활성화 시 첨부 가능, 최대 5개 |
| 액션 버튼 | 목록, 저장, 미리보기, 발송 (테스트/실/재발송) |

* * *

### 3. ✅ 파일 처리

* 저장 시 HTML/Excel 파일 자동 생성
* 생성된 파일 미리보기 기능 제공 (`/billing/[id]/preview` 가능)
* 다운로드 버튼은 첨부파일 영역에서 노출

* * *

### 4. ✅ 발송 처리

| 조건 | 처리 방식 |
| --- | --- |
| 이메일 미입력 | 발송 불가 + 얼럿 표시 |
| 선택 발송 | 리스트에서 체크 후 → 이메일 입력 및 첨부파일 선택 → 발송 버튼 클릭 |
| 발송 유형 | 테스트 / 실제 / 재발송 구분 선택 가능 |
| 발송 후 상태 | 성공/실패 DB 기록 + 발송일 업데이트 |

* * *

### 5. 🧪 프론트 테스트 항목

* 날짜 검색 및 기본 월 노출 로직 검증
* 셀렉박스 & 검색어 조합 정상 작동
* 목록에서 수정 페이지 이동 확인
* 파일 다운로드 버튼 클릭 시 정상 다운로드
* 발송 시 이메일 필드 체크 여부
* HTML/Excel 미리보기 렌더링 확인
* 파일 업로드 조건(용량, 개수, 확장자) 유효성 검사

* * *

## ✅ C. 백엔드 기능명세서

### 1. 📡 API: 목록 조회

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/billing` |
| 메서드 | `GET` |
| Query Params | `fromDate`, `toDate`<br>`searchField`: `name`, `code`, `ceo`, `email`<br>`searchValue`: string<br>`status`: `all`, `not_sent`, `success`, `fail`<br>`page`, `limit` |

* * *

### 2. 📡 API: 상세 조회

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/billing/[id]` |
| 메서드 | `GET` |

* * *

### 3. 📡 API: 저장

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/billing` |
| 메서드 | `POST` or `PUT` (id 포함 시 수정) |
| 데이터 | 전체 청구서 입력 필드 |

* * *

### 4. 📡 API: 파일 생성

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/billing/[id]/generate` |
| 메서드 | `POST` |
| 설명 | HTML/Excel 파일 자동 생성 |

* * *

### 5. 📡 API: 발송

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/billing/send` |
| 메서드 | `POST` |
| Request Body | ```json
{
  "ids": [1, 2, 3],
  "type": "real", // or "test", "resend"
  "emails": {
    "1": "user1@example.com",
    "2": "user2@example.com"
  },
  "attachments": {
    "1": ["manual.pdf"]
  }
}
``` |

* * *

### 6. 📡 API: SAP RFC 호출

| 항목 | 설명 |
| --- | --- |
| 경로 | `/api/sap/rfc-update` |
| 메서드 | `POST` |
| 설명 | 묶음번호 기준 계약 정보 최신화 |

* * *

## ✅ D. DB 테이블 요약

### 📌 billing_invoices

| 컬럼 | 설명 |
| --- | --- |
| `id` | 고유 ID |
| `vendor_id` | 사업자 FK |
| `email` | 발송 이메일 |
| `billing_month` | 청구월 |
| `payment_info` | 결제 정보 |
| `details` | JSON (청구대금 상세) |
| `attachments` | JSON (업로드 파일 목록) |
| `status` | `미발송`, `성공`, `실패` |
| `sent_at` | 최근 발송일 |
| `created_by`, `updated_by` | 관리자 ID |
| `created_at`, `updated_at` | 생성/수정일 |

### 📌 billing_logs (발송 이력)

| 컬럼 | 설명 |
| --- | --- |
| `id` | 고유 ID |
| `invoice_id` | 청구서 FK |
| `sent_at` | 발송일 |
| `status` | 성공/실패 |
| `type` | 테스트/실제/재발송 | 